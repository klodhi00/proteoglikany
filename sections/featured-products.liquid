{% comment %}
  Sekcja: Featured Products
  Wyświetla produkty z wybranej kolekcji w układzie grid (desktop) lub slider (mobile)
  Zgodność: Shopify Online Store 2.0, WCAG 2.1 AA
{% endcomment %}

<section class="featured-products">
  <div class="featured-products__outer-wrapper">
    <div class="featured-products__inner-wrapper">
      
      {%- if section.settings.tag_text != blank -%}
        <div class="featured-products__tag">{{ section.settings.tag_text }}</div>
      {%- endif -%}
      
      {%- if section.settings.heading != blank -%}
        <h2 class="featured-products__heading">{{ section.settings.heading }}</h2>
      {%- endif -%}

      {%- liquid
        assign collection = collections[section.settings.collection]
        assign products_to_show = section.settings.products_count | default: 4
        assign metafield_namespace = section.settings.metafield_namespace
        assign metafield_key = section.settings.metafield_key
      -%}

      {%- if collection != blank and collection.products_count > 0 -%}
        <div class="featured-products__container">
          <div class="featured-products__grid">
            {%- for product in collection.products limit: products_to_show -%}
              {%- assign current_variant = product.selected_or_first_available_variant -%}
              <article class="featured-products__item">
                
                <div class="featured-products__image-wrapper">
                  {%- if product.featured_image -%}
                    <img
                      src="{{ product.featured_image | image_url: width: 600 }}"
                      srcset="{{ product.featured_image | image_url: width: 300 }} 300w,
                              {{ product.featured_image | image_url: width: 600 }} 600w"
                      sizes="(min-width: 1024px) 25vw, 50vw"
                      alt="{{ product.featured_image.alt | escape }}"
                      loading="lazy"
                      width="{{ product.featured_image.width }}"
                      height="{{ product.featured_image.height }}"
                      class="featured-products__image"
                    >
                  {%- else -%}
                    <div class="featured-products__image-placeholder">
                      {{ 'product-1' | placeholder_svg_tag: 'featured-products__placeholder-svg' }}
                    </div>
                  {%- endif -%}
                </div>

                <div class="featured-products__content">
                  <h3 class="featured-products__title">{{ product.title }}</h3>

                  <div class="featured-products__price-wrapper">
                    {%- if current_variant.compare_at_price != blank and current_variant.compare_at_price > current_variant.price -%}
                      <s class="featured-products__price featured-products__price--compare">
                        {{ current_variant.compare_at_price | money }}
                      </s>
                      <strong class="featured-products__price featured-products__price--sale">
                        {{ current_variant.price | money }}
                      </strong>
                    {%- else -%}
                      <p class="featured-products__price">
                        {{ current_variant.price | money }}
                      </p>
                    {%- endif -%}
                  </div>

                  {%- if metafield_namespace != blank and metafield_key != blank -%}
                    {%- assign metafield_value = product.metafields[metafield_namespace][metafield_key] -%}
                    {%- if metafield_value != blank -%}
                      <p class="featured-products__additional-text">{{ metafield_value }}</p>
                    {%- endif -%}
                  {%- endif -%}

                  <button 
                    type="button" 
                    class="featured-products__button button button--outline-blue"
                    data-product-id="{{ current_variant.id }}"
                    aria-label="{{ 'products.product.add_to_cart' | t }}: {{ product.title | escape }}"
                  >
                    {{ section.settings.button_text | default: 'Dodaj do koszyka' }}
                  </button>
                </div>

              </article>
            {%- endfor -%}
          </div>
        </div>

        {%- if section.settings.show_navigation -%}
          <div class="featured-products__navigation">
            <button 
              type="button" 
              class="featured-products__nav-button featured-products__nav-button--prev" 
              aria-label="{{ 'general.slider.previous_slide' | t }}"
            >
              {%- if section.settings.nav_icon_prev != blank -%}
                <img 
                  src="{{ section.settings.nav_icon_prev | image_url: width: 48 }}" 
                  alt="" 
                  class="featured-products__nav-icon"
                  width="24"
                  height="24"
                >
              {%- else -%}
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              {%- endif -%}
            </button>
            <button 
              type="button" 
              class="featured-products__nav-button featured-products__nav-button--next" 
              aria-label="{{ 'general.slider.next_slide' | t }}"
            >
              {%- if section.settings.nav_icon_next != blank -%}
                <img 
                  src="{{ section.settings.nav_icon_next | image_url: width: 48 }}" 
                  alt="" 
                  class="featured-products__nav-icon"
                  width="24"
                  height="24"
                >
              {%- else -%}
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              {%- endif -%}
            </button>
          </div>
        {%- endif -%}

      {%- else -%}
        <p class="featured-products__empty">{{ 'sections.featured_products.no_products' | t }}</p>
      {%- endif -%}

    </div>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const container = document.querySelector('.featured-products__container');
    const grid = document.querySelector('.featured-products__grid');
    const prevButton = document.querySelector('.featured-products__nav-button--prev');
    const nextButton = document.querySelector('.featured-products__nav-button--next');
    
    if (!container || !grid) return;

    let currentIndex = 0;
    
    function getItemsPerView() {
      if (window.innerWidth < 480) return 1;
      if (window.innerWidth < 768) return 2;
      return 0;
    }

    function getItemWidth() {
      const item = grid.querySelector('.featured-products__item');
      if (!item) return 0;
      const computedStyle = window.getComputedStyle(item);
      return item.offsetWidth + parseFloat(computedStyle.marginRight || 0);
    }

    function getTotalItems() {
      return grid.querySelectorAll('.featured-products__item').length;
    }

    function updateButtons() {
      if (!prevButton || !nextButton) return;
      
      const itemsPerView = getItemsPerView();
      if (itemsPerView === 0) return;
      
      const totalItems = getTotalItems();
      
      if (currentIndex <= 0) {
        prevButton.classList.add('swiper-button-disabled');
      } else {
        prevButton.classList.remove('swiper-button-disabled');
      }

      if (currentIndex >= totalItems - itemsPerView) {
        nextButton.classList.add('swiper-button-disabled');
      } else {
        nextButton.classList.remove('swiper-button-disabled');
      }
    }

    function scrollToIndex(index) {
      const itemsPerView = getItemsPerView();
      if (itemsPerView === 0) return;
      
      const itemWidth = getItemWidth();
      const totalItems = getTotalItems();
      
      currentIndex = Math.max(0, Math.min(index, totalItems - itemsPerView));
      
      const scrollPosition = currentIndex * itemWidth;
      grid.scrollTo({ left: scrollPosition, behavior: 'smooth' });
      
      setTimeout(updateButtons, 300);
    }

    if (prevButton) {
      prevButton.addEventListener('click', function() {
        const itemsPerView = getItemsPerView();
        scrollToIndex(currentIndex - itemsPerView);
      });
    }

    if (nextButton) {
      nextButton.addEventListener('click', function() {
        const itemsPerView = getItemsPerView();
        scrollToIndex(currentIndex + itemsPerView);
      });
    }

    if (window.innerWidth < 768) {
      updateButtons();
    }

    // Dodawanie produktu do koszyka
    const addToCartButtons = document.querySelectorAll('.featured-products__button');
    
    addToCartButtons.forEach(button => {
      button.addEventListener('click', async function() {
        const variantId = this.getAttribute('data-product-id');
        
        try {
          const response = await fetch('/cart/add.js', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              items: [{
                id: variantId,
                quantity: 1
              }]
            })
          });

          if (response.ok) {
            window.location.href = '/cart';
          }
        } catch (error) {
          console.error('Error adding to cart:', error);
        }
      });
    });
  });
</script>

{% schema %}
{
  "name": "Polecane produkty",
  "tag": "section",
  "class": "section-featured-products",
  "settings": [
    {
      "type": "text",
      "id": "tag_text",
      "label": "Tekst tagu",
      "default": "POLECANE"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Nagłówek sekcji",
      "default": "Może Ci się spodobać"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Kolekcja produktów"
    },
    {
      "type": "range",
      "id": "products_count",
      "label": "Liczba produktów do wyświetlenia",
      "min": 2,
      "max": 12,
      "step": 1,
      "default": 4
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Tekst przycisku",
      "default": "Dodaj do koszyka"
    },
    {
      "type": "header",
      "content": "Dodatkowy tekst z metafield"
    },
    {
      "type": "text",
      "id": "metafield_namespace",
      "label": "Namespace metafield",
      "info": "Np. 'custom' lub 'product'"
    },
    {
      "type": "text",
      "id": "metafield_key",
      "label": "Klucz metafield",
      "info": "Np. 'subscription_text' lub 'additional_info'"
    },
    {
      "type": "header",
      "content": "Nawigacja slidera (mobile)"
    },
    {
      "type": "checkbox",
      "id": "show_navigation",
      "label": "Pokaż strzałki nawigacji",
      "default": true
    },
    {
      "type": "image_picker",
      "id": "nav_icon_prev",
      "label": "Ikona strzałki w lewo (opcjonalnie)"
    },
    {
      "type": "image_picker",
      "id": "nav_icon_next",
      "label": "Ikona strzałki w prawo (opcjonalnie)"
    }
  ],
  "presets": [
    {
      "name": "Polecane produkty"
    }
  ]
}
{% endschema %}